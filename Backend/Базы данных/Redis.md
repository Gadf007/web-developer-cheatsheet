# Redis

- [Описание](#описание)
- [Где используется](#где-используется)
- [Типы данных](#типы-данных)
- [Установка](#установка)
- [Использование](#использование)
- [Строки](#строки)
- [Хэши](#хэши)
- [Списки](#списки)
- [Множества](#множества)
- [Упорядоченные множества](#упорядоченные-множества)
- [Полезные ссылки](#полезные-ссылки)

## Описание

**Redis** (**Re**mote **Di**ctionary **S**erver) — нереляционная высокопроизводительная СУБД. Redis хранит все данные в памяти, доступ к данным осуществляется по ключу. Опционально копия данных может храниться на диске. Этот подход обеспечивает производительность, в десятки раз превосходящую производительность реляционных СУБД, а также упрощает секционирование (шардинг) данных.

**Особенности:**

- Умеет сохранять данные на диск. Можно настроить Redis так, чтобы данные вообще не сохранялись, сохранялись периодически по принципу copy-on-write, или сохранялись периодически и писались в журнал (binlog)
- В отличие от Memcached, позволяет хранить не только строки, но и массивы, словари, множества без повторов, большие массивы бит (bitmaps), а также множества, отсортированные по некой величине. Разумеется, можно работать с отдельными элементами списков, словарей и множеств. Как и Memcached, Redis позволяет указать время жизни данных (двумя способами — «удалить тогда-то» и «удалить через …»). По умолчанию все данные хранятся вечно
- Redis — однопоточный сервер. Сильно упрощает поддержку кода, обеспечивает атомарность операций и позволяет запустить по одному процессу Redis на каждое ядро процессора. Разумеется, каждый процесс будет прослушивать свой порт
- Есть репликация. Репликация с несколькими главными серверами не поддерживается. Каждый подчиненный сервер может выступать в роли главного для других. Репликация в Redis не приводит к блокировкам ни на главном сервере, ни на подчиненных. На репликах разрешена операция записи. Когда главный и подчиненный сервер восстанавливают соединение после разрыва, происходит полная синхронизация (resync)
- Поддерживает транзакции (будут последовательно выполнены либо все операции, либо ни одной) и пакетную обработку команд (выполняем пачку команд, затем получаем пачку результатов)
- Поддержка механизма publish/subscribe. С его помощью приложения могут создавать каналы, подписываться на них и помещать в каналы сообщения, которые будут получены всеми подписчиками
- Очень прост и прекрасно документирован
- На одном сервере можно держать несколько пронумерованных баз данных, по умолчанию их 16
- Приложения, использующие Redis, удобно профилировать (команда `slowlog`) и отлаживать (команда `monitor`)
- Redis написан таким образом, что резервную копию его базы данных можно сделать простым копированием файла дампа, даже во время работы сервера
- Доступ к серверу можно защитить паролем



## Где используется

- Хранилище сессий и профилей пользователей
- Сервер очередей, механизм publish/subscribe
- Полноценная замена Memcached, притом в случае с Redis мы получим репликацию, более длинные ключи и значения, возможность восстановления кэша с диска
- Место для хранения количества пользователей онлайн, кодов капч, различных флагов
- СУБД для небольших приложений — сокращения ссылок, имиджбордов, возможно даже блогов
- Роль «словаря» в шардинге, то есть сервер, который знает, какие шарды на каких серверах искать
- Хранилище промежуточных результатов вычислений при обработке больших объемов данных



## Типы данных

- **Строки** (string). Базовый тип данных Redis. Строки в Redis бинарно-безопасны, _могут использоваться так же как числа,_ ограничены размером 512 Мб
- **Хеш-таблицы** (hashes). Классические хеш-таблицы или ассоциативные массивы. Максимальное количество пар «ключ-значение» — 2^32 - 1
- **Списки** (lists). Классические списки строк, упорядоченные в порядке вставки, которая возможна как со стороны головы, так и со стороны хвоста списка. Максимальное количество элементов — 2^32 - 1
- **Множества** (sets). Множества строк в математическом понимании: не упорядочены, поддерживают операции вставки, проверки вхождения элемента, пересечения и разницы множеств. Максимальное количество элементов — 2^32 - 1
- **Упорядоченные множества** (sorted sets). Упорядоченное множество отличается от обычного тем, что его элементы упорядочены по особому параметру `score`



## Установка

```bash
# Установка (Unix)
sudo add-apt-repository ppa:chris-lea/redis-server
sudo apt-get update
sudo apt-get install redis-server
# Установка (macOS)
brew install redis

# Открыть порт для доступа извне
# Строку "bind 127.0.0.1" заменить на "bind 0.0.0.0"
sudo vi /etc/redis/redis.conf

# Обновить конфиг для запуска в фоне
# Изменить "daemonize no" на "daemonize yes"
vi /usr/local/etc/redis.conf
```



## Использование

```bash
# Запуск сервера (Unix)
sudo service redis-server start
# Запуск сервера (macOS)
redis-server
# Запуск как сервис (macOS)
brew services start redis

# Остановка сервера (Unix)
sudo service redis-server stop
# Остановка сервера (macOS)
redis-cli shutdown
# Запуск сервиса (macOS)
brew services stop redis

# Проверить статус
redis-cli ping
```



## Строки

| Команда | Описание |
| --- | --- |
| APPEND key value | Добавляет значение в конец данных, либо если такого ключа еще нет, создает его |
| DECR key | Уменьшает на единицу значение числа. В случае, если заданный ключ будет содержать строку, будет сгенерирована ошибка |
| DECRBY key decrement | Уменьшает числовое значение на переданное число |
| GET key | Возвращает значение ключа |
| GETRANGE key start end | Возвращает подстроку строкового значения |
| GETSET key value | Устанавливает в переданный ключ строковое значение и возвращает предыдущее |
| INCR key | Увеличивает на единицу значение числа. В случае, если заданный ключ содержит строку, будет вызвана ошибка |
| INCRBY key increment | Увеличивает числовое значение на переданное число |
| INCRBYFLOAT key increment | Позволяет увеличивать число, хранящееся в строке на число с плавающей запятой, в отличие от INCRBY, который позволяет увеличивать число только на целочисленное значение |
| MGET key [key ...] | Возвращает значение ключа / ключей, переданных в параметрах |
| MSET key value [key value ...] | Устанавливает значение ключа / значения ключей, которые переданы в параметрах |
| MSETNX key value [key value ...] | Устанавливает значение ключа / значение ключей, если таких ключей еще нет в базе данных. Операция является атомарной, что означает, если хотя бы один ключ существует, то операция не установит ни один из ключей |
| PSETEX key milliseconds value | Записывает в ключ строковое значение и устанавливает время жизни ключа в миллисекундах |
| SET key value [EX seconds] [PX milliseconds] [NX\|XX] | Записывает строковое значение в переданный ключ. Если ключ до этого существовал, то он будет перезаписан |
| SETEX key seconds value | Записывает в ключ строковое значение и устанавливает время, через которое ключ будет уничтожен |
| SETNX key value | Записывает строковое значение, если такого ключа еще нет в базе данных |
| STRLEN key | Возвращает длину строкового значения определенного ключа |



## Хэши

| Команда | Описание |
| --- | --- |
| HDEL key field [field ...] | Удаляет поле / поля из ключа |
| HEXISTS key field | Проверяет, есть ли поле с таким именем в переданном хэше |
| HGET key field | Возвращает значение, которое ассоциировано с полем в хэше |
| HGETALL key | Возвращает все поля и значения для ассоциированного с ключом хэша |
| HINCRBY key field increment | Увеличивает числовое значение поля, хранящегося в ключе |
| HINCRBYFLOAT key field increment | Увеличивает числовое значение поля, которое хранится в ключе, на число с плавающей запятой |
| HKEYS key | Получение всех полей указанного хэша |
| HLEN key | Возвращает количество полей, которые находятся в хэше |
| HMGET key field [field ...] | Получает значение поля / полей указанного хэша |
| HMSET key field value [field value ...] | Записывает значения в поля хэша |
| HSET key field value | Добавляет в хэш поле и значение. Если такого ключа не существовало, он будет добавлен. В случае, если такое поле в хэше уже существует, оно будет перезаписано |
| HSETNX key field value | Устанавливает значение поля в хэше только в том случае, если до этого оно не существовало |
| HSTRLEN key field | Возвращает длину строкового значения поля определенного хэша |
| HVALS key | Возвращает все значения переданного хэша |



## Списки

| Команда | Описание |
| --- | --- |
| LINDEX key index | Возвращает значение списка по заданному индексу |
| LINSERT key BEFORE\|AFTER pivot value | Вставляет значение до или после уже существующего значения |
| LLEN key | Возвращает количество значений находящихся в списке |
| LPOP key | Удаляет и возвращает первый элемент списка |
| LPUSH key value [value ...] | Вставляет в начало списка переданные значения. Если ключ до этого не существовал, то в этом случае он будет создан |
| LPUSHX key value | Вставляет значение в начало списка, только если ключ уже существует и содержит в себе список |
| LRANGE key start stop | Возвращает диапозон значений указанного списка |
| LREM key count value | Удаляет элементы, которые равны значению. Параметр «количество» указывает, сколько таких элементов надо удалить. Переданный 0 означает, что необходимо удалить все вхождения |
| LSET key index value | Записывает значение по указанному индексу в список |
| LTRIM key start stop | Ограничивает список значениями, которые находятся в диапозоне переданных индексов |
| RPOP key | Удаляет и возвращает последний элемент списка |
| RPOPLPUSH source destination | Удаляет из источника последний элемент и записывает его в начало списка приемника |
| RPUSH key value [value ...] | Добавляет элементы в конец списка. Если до этого данный ключ не существовал, тогда он будет создан |
| RPUSHX key value | Вставляет в конец списка элемент, но только в том случае, если ключ уже создан и содержит в себе список |



## Множества

| Команда | Описание |
| --- | --- |
| SADD key member [member ...] | Создает множество с одним или несколькими значениями |
| SCARD key | Возвращает количество элементов, которые хранятся в множестве |
| SDIFF key [key ...] | Возвращает разницу между первым множеством и остальными |
| SDIFFSTORE destination key [key ...] | Записывает в приемник те элементы, которые не совпадают с первым множеством. Для лучшего понимания смотреть SDIFF |
| SINTER key [key ...] | Возвращает все элементы, которые совпадают в переданных множествах |
| SINTERSTORE destination key [key ...] | Данная команда записывает в приемник все элементы, которые совпали в множествах, переданных в параметрах |
| SISMEMBER key member | Возвращает 1, если данный элемент присутствует в данном множестве. В ином случае будет выведен 0 |
| SMEMBERS key | Возвращает все элементы множества |
| SMOVE source destination member | Переносит элемент из одного множества в другое |
| SPOP key | Удаляет и возвращает случайный элемент или элементы (если задано количество) из множества. Аргумент «количество» доступен с версии 3.2 |
| SRANDMEMBER key [count] | Возвращает случайный элемент или элементы (если указано количество) из множества. Аргумент «количество» доступен начиная с версии 2.6 |
| SREM key member [member ...] | Удаляет элементы или элементы из множества |
| SUNION key [key ...] | Объединяет элементы множеств |
| SUNIONSTORE destination key [key ...] | Записывает в приемник все уникальные элементы переданных множеств |



## Упорядоченные множества

| Команда | Описание |
| --- | --- |
| ZADD key score member [score member ...] | Создает упорядоченное множество, которое сортируется по весовым коэффициентам. Не содержит дубликатов. Если элемент повторяется, то весовое значение обновляется и элемент перезаписывается в нужное место, чтобы поддерживать отсортированность |
| ZCARD key | Возвращает количество элементов в упорядоченном множестве |
| ZCOUNT key min max | Возвращает количество элементов, которые лежат в промежутке между минимальным и максимальным значением |
| ZINCRBY key increment member | Увеличивает весовой коэффициент элемента на переданное значение |
| ZRANGE key start stop [WITHSCORES] | Возвращает элементы отсортированного множества, начиная с начального индекса и заканчивая конечным |
| ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count] | Возвращает все элементы, весовые коэффициенты у которых находятся между минимальным и максимальным значениями |
| ZRANK key member | Возвращает индекс элемента. Отсчет начинается с 0. Элемент с индексом 0 имеет самый маленький весовой коэффициент |
| ZREM key member [member ...] | Удаляет элемент / элементы из указанного отсортированного множества |
| ZREMRANGEBYRANK key start stop | Удаляет все элементы отсортированного множества, которые находятся между начальным и конечным индексами |
| ZREMRANGEBYSCORE key min max | Удаляет все элементы из отсортированного множества, весовые коэффициенты которых находятся между минимальным и максимальным значением |
| ZREVRANGE key start stop [WITHSCORES] | Возвращает все элементы, которые находятся между начальным и конечным индексами. Данные для этой команды представлены в обратном порядке, от большего к меньшему |
| ZREVRANK key member | Выводит индекс элемента. Отсчет начинатся с 0. Элемент с индексом 0 имеет самый большой весовой коэффициент и далее по убыванию |
| ZSCORE key member | Возвращает весовой коэффициент элемента |



## Полезные ссылки

- [Документация](https://redis.io/documentation)
- [Описание команд](https://progtask.ru/komandy-redis/)
- [PHP + Redis](https://ruseller.com/lessons.php?rub=37&id=2289)